# 亿级流量系统多级缓存高并发系统架构实战二

## CDN
想达到负载均衡的效果还不想使用任何一台服务器该如何做？域名（CDN）。CDN网络是在用户和服务器之间加一层cache。域名要解析为IP才能去访问网站。通过一个浏览器（其他应用程序后面讲），怎么把一个
域名变成一个IP地址？浏览器跑在一个操作系统上，当输入一个域名胡扯之后，他先从`/etc/hosts`文件里查找该域名所对应的IP，如果找到了，浏览器就直接使用这个IP；如果没有，就从操作系统底层的DNS
缓存中去找，这些缓存都是原来在互联网上请求过的，然后缓存到本地来的。如果还是没有，则去DNS服务器地址查找，然后缓存到本地，而DNS服务器的地址在网卡上配了：114.114.114.114.如果没有配置或者
配的不对，就会得不到正确的域名解析。DNS只是存储了域名对IP的键值对，各个运营商什么都有DNS服务器、互联网公司如Google会自己搭建DNS服务器，他们的数据从哪里来呢？购买域名的时候，会配置DNS服
务器，这个DNS也有域名解析的数据，他接到注册之后，会广播，提交到全网的DNS（包括根），然后浏览器就能拿到域名对应的IP了。通过浏览器访问域名，必须得是域名在公网能够正确解析才可以。  

这里面有个问题：1. 刚配置的那一台DNS服务器压力会很大 2. 广播的时候，怎么才能广播到所有全网这些服务器上? 需要多长时间（小于24小时，有点像zk，不会立即生效）  

这一台配置的DNS服务器是通过一个IP地址映射到一组机器上，统一的出口。一段特别短的数据就特别容易及时反馈回来。还有一个域名缓存的问题，最初的配置域名改了怎么办？配置的DNS服务器域名解析的时候，
那里面有一个TTL，经过多长时间就过期，要重新广播。闲篇扯完回归正题。  

如果一个域名发到DNS之后可以返回多个IP地址，则就可以根据域名做负载均衡了。而DNS技术是支持这一点的（域名申请时配置的得是个只能DNS服务器地址）。但是要告诉他，究竟返回这几个IP中的哪一个？
可以登陆智能DNS进行配置。智能DNS服务器可以得到客户端的IP，并分析出他的地点，在不同地区的机房的机器就接受来自各自地区的请求，以达到低延迟。有这么个"一秒定律"： 刷新页面的时候，来自比较近的
服务器的延迟比较低，这里不是物理上的距离，而是算的网络距离，联通和电信的两台机器，即便是物理距离不远，通信的延迟也是很高的。知道IP就知道是哪个ISP提供商，像是这种视频、直播app，他们在全网
的节点的搭建是非常多的，目的就是达到"一秒定律"，不管是直播还是录播的短视频，能做到一点在一秒内就能打开，一刷在下一秒就能切换到下一个，那就需要拉近距离，第一就是区域的距离（物理和网络的距离，
海南的用户别访问哈尔滨的服务器，电信的访问电信的，联通的访问联通的，独立的区域内还要部署跨ISP的多节点的访问），这实际就是把集中在一起的机房机器分散到全国各地去，不同地区的用户访问的nginx
服务器也不一样，这就可以快速响应用户的请求，这种技术就叫CDN。各个nginx不在一个地方，目的就是"一秒定律"。过去是"三秒法则"，现在随着网络越来越好、4G变5G，宽带也越来越便宜，动不动就是几百兆
的，虽然带宽上来了，但是岩石下不来也不行，比如网游和视频会议，这就需要全球去部署nginx节点。接下来考虑一个问题，这些nginx服务器上放什么？

全球各地的nginx上可以放：html、js、css、静态图片。可以做基于反向代理的负载均衡、动静分离、写脚本做软防火墙、生成验证码等等。还可以放音视频点播资源、大文件下载。如何治理这些静态资源成了个
问题。解决这个问题需要开发一个应用系统DNS服务（或者使用云服务/zk），放在应用服务器集群和各个nginx之间，三者同步数据的时候要开socket走各种网络IO（netty）。跨机房或者异地的数据备份、请求
备份、提速。异地多活跟CDN很像。服务器里的数据存在哪儿呢？nginx有内存缓存，可以用：  
1. lua_shared_dict做全局缓存，他借助的是lua语言，拿到ngx.shared.shared_data,访问的是nginx内存里面的缓存数据  
2. lua-resty-lrucache 

根据地点、进行配置给出IP  